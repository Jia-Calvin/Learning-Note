# TCP/IP 三次握手、四次挥手总结
- 知乎详解 https://zhuanlan.zhihu.com/p/38527757
- TCP （Transmission Control Protocol） 是含有“面向连接”特性属于传输层协议，也就是说在正式通信前必须与对方建立可靠地连接
- 三次握手就是为了建立一种可靠地连接
- TCP 是一种可靠地数据传输，如何达到可靠地传输靠的就是在数据传输时的协议
- 四次挥手是为了断开连接



## 三次握手 (客户端张三，服务端李四)

#### 过程如下:
- 张三向李四打招呼 （client向server发送一个syn）
- 李四看到后向张三笑了一笑 （server向client发送ack）
- 李四害怕张三不是向自己打招呼，再向李四打招呼 （server向client发送了一个syn）
- 张三知道李四是为了确认自己，因此他也向李四笑了一笑 （client向server发送ack）

#### 过程简化:
过程尽管有四个，但是在中间过程中server向client发送ack+syn可以进行合并为一个连续地发送，因此最终为三次握手过程

#### 过程的状态变化：
- 无论是client还是server都有一个中间过渡态（从listening->中间态->established的状态）
- client的过渡态是syn_sent (syn package has been sent)，server的过渡态是syn_rcvd (syn package has been received)
- 这两个状态叫着「半打开」状态，实则就是向对方招手了，但是还没来得及看到对方的点头微笑



## TCP数据可靠传输 (客户端张三，服务端李四)
数据地可靠传输是在建立起了可靠连接后进行的，这时候客户端以及服务端都应该是established的状态，这样两者才可以进行数据传输。

#### 过程如下:
- 张三告诉李四一些话 (client向server发送data)
    + 张三可以连续向李四发送多个数据，而不用一个一个发送，两人之间需要有协商好的合适的发送和接受速率，这个就是「TCP窗口大小」
- 李四向张三点点头 (server向client发送ack)
    + 李四可以在接受完多个数据后，一起向张三回复说前面你说的那些话我都听见了，这就是批量ack。

#### 如何可靠:
- 重传机制：clinet告诉server的话被大风吹走或者是server回复client的话被大风吹走，这时候client需要重传数据
- 去重机制：server就有可能同一句话听见了两次，server必须将重复的话给去掉



## 四次挥手 (客户端张三，服务端李四)

#### 过程如下:
- 张三向李四挥挥手（client向server发送一个fin）
- 李四看到后向张三离别地笑了一笑 （server向client发送ack）
- 李四在说完所有的话后累了，向张三也挥挥手 （server向client发送了一个fin）
- 张三也向李四离别地笑了一笑 （client向server发送ack）

#### 过程不简化:
中间的两个动作之所以没有合并，是因为tcp存在「半关闭」状态，也就是单向关闭。张三向李四挥挥手，可是人还没有走，只是不再说话，但是耳朵还是可以继续听，李四可以继续说话（发送数据给张三），等待李四累了，也不再说话了，朝张三挥了挥手，张三伤感地微笑了一下，才彻底结束了。


#### 过程的状态变化：
- 有一个非常特殊的状态time_wait，参考知乎，说的挺好的。
  - 解决last_ack可能出现丢失问题，使得对方一直在等
  - 解决了网络中残留的数据包，2MSL可以使得网络残留的数据包都消失，不影响新的链接建立在该端口

- 四次挥手可以合并成三次挥手
  - 当被动关闭的一方也不需要发送数据时，可以直接ack+fin
  - 此时就是三次挥手就会关闭连接，但time_wait状态仍然无法避免



<!-- <meta http-equiv="refresh" content="1"> -->